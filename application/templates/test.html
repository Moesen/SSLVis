<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="../static/js/lib/d3.js"></script>
</head>
<body>

<svg width="300" height="300">

</svg>
<script>
    function center(nodes, width, height) {
        let m_center = {x:0, y:0};
        for(let node of nodes){
            m_center.x += node.x;
            m_center.y += node.y;
        }
        m_center.x /= nodes.length;
        m_center.y /= nodes.length;
        let delta = {
            x:width/2 - m_center.x,
            y:height/2 - m_center.y
        };
        for(let node of nodes){
            node.x += delta.x;
            node.y += delta.y;
        }
    }
    function draw_nodes(svg, nodes) {
        svg.selectAll("*").remove();
        let nodes_ele = svg.selectAll("circle").data(nodes)
            .enter()
            .append("circle")
            .attr("cx", d => d.x)
            .attr("cy", d => d.y)
            .attr("r", d => d.r)
            .attr("fill", "none")
            .attr("stroke", "black")
            .attr("stroke-width", 1)
    }
    function fd(nodes, width, height) {
        let simulate = d3.forceSimulation(nodes)
             .force("charge", d3.forceManyBody().strength(100))
            .force("collision", d3.forceCollide(d => d.r).strength(1))
            .force("center", d3.forceCenter(width/2, height/2));
        console.log("begin tick");
        simulate.stop();
        for(let i=0; i<500; i++){
            simulate.tick();
        }
    }
    function scalefd(nodes, width, height) {
        let min_x = 1000000;
        let max_x = -1000000;
        let min_y = 1000000;
        let max_y = -1000000;
        for(let node of nodes){
            min_x = Math.min(min_x, node.x-node.r);
            max_x = Math.max(max_x, node.x+node.r);
            min_y = Math.min(min_y, node.y-node.r);
            max_y = Math.max(max_y, node.y+node.r);
        }
        let scale = Math.min(width/(max_x-min_x), height/(max_y-min_y));
        console.log(scale);
        scale *= 0.95;
        for(let node of nodes){
            node.r *= scale;
            node.x *= scale;
            node.y *= scale;
        }
        fd(nodes, width, height);
        center(nodes, width, height);
        draw_nodes(svg, nodes);
    }
</script>
<script>
    // init
    let svg = d3.select("svg");
    let width = 600;
    let height = 600;
    svg.attr("width", width);
    svg.attr("height", height);
    let nodes = [
        {x:0, y:0, r:40},
       // {x:100, y:100, r:60},
        //{x:100, y:0, r:120}
    ];
    fd(nodes, width, height);
    for(let node of nodes){
        console.log(node.x, node.y)
    }
    scalefd(nodes, width, height);
    draw_nodes(svg, nodes);


</script>

</body>
</html>